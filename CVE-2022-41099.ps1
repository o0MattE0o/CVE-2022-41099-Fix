## Windows 10 21H2 19044.2486

Start-Transcript -Path "C:\WinRE-Logs.log" -Force
$WindowsVersion = (Get-ItemProperty "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion").UBR
If ($WindowsVersion -eq "2486 ") {
    #Correct Windows Version (change to required windows version.
    Write-Host "Correct Version of Windows Detected (OS Build 19044.2486)"
    # Check Version of Recovery Drive (WinRE.wim)
    Write-Host "Checking winre.wim Version:"
    $WINREA = reagentc /info | findstr "\\?\GLOBALROOT\device"
    $WINREB = $WINREA.replace("Windows RE location: ","").TRIM()
    $WINREC = $WINREB + "\winre.wim"
    $WINRED = $WINREC + " /index:1"
    $WINREE = "Dism /Get-ImageInfo /ImageFile:$WINRED"
    $WINREF = Invoke-Expression $WINREE
    #Change number to build you require so the script does not keep overwriting.
    If ($WINREF -contains "ServicePack Build : 2486") {
        Write-Host "No Action required your winre.wim file is up-to-date"
    } Else {
        Write-Host "Detect Recovery Drives"
        $DiskNo = (Get-Disk).Number
        $RecoveryDiskNo = (Get-Partition | Where-Object -FilterScript {$_.Type -eq 'Recovery'}).PartitionNumber
        Write-Host "Found Recovery Disk on Partition: " $RecoveryDiskNo
        #Check Each Recovery Drive for winre.wim file
        foreach ($Drive in $RecoveryDiskNo) {
            # not testing if this removes network drives.
            $DriveLetter = ls function:[d-z]: -n | ?{ !(test-path $_) } | random
            $DriveLetter = $DriveLetter -replace "[:]",""
            Get-Partition -PartitionNumber $Drive | Set-Partition -NewDriveLetter $DriveLetter
            $DriveLetter = $DriveLetter + ":"
            If (Test-Path $DriveLetter\recovery\windowsre\winre.wim) {
                Write-Host "Windows Recovery Drive Detected"
                Write-Host "Updating WinRE.wim file" 
                Takeown /F "$DriveLetter\recovery\windowsre\" /A /R /D Y
                ICACLS "$DriveLetter\recovery\windowsre\" /grant administrators:F
                attrib -h -r -s /s /d $DriveLetter\*.*
                Copy-Item -Path ".\winre-compress.wim" -destination "$DriveLetter\recovery\windowsre\winre.wim" -Force -Verbose
                Remove-PartitionAccessPath -DiskNumber $DiskNo -PartitionNumber $Drive -AccessPath $DriveLetter
            } else {
                #Some Manufacturers laptops have secoundary recovery drive that has no WINRE.wim.
                Write-Error "None Windows Recovery Drive Detected"
                Write-Host "No action required"
                Remove-PartitionAccessPath -DiskNumber $DiskNo -PartitionNumber $Drive -AccessPath $DriveLetter
            }
        }
    }
} else {
    #Wrong Version of Windows
    Write-Error "Your Running the wrong version of windows"
}
Stop-Transcript
